<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client-Side PDF Toolkit</title>

    <script>
        // ตรวจสอบ "ตั๋ว"
        if (sessionStorage.getItem('allowAppAccess') !== 'true') {
            // ถ้าไม่มีตั๋ว (เช่น กด F5 หรือเข้าตรงๆ)
            // ให้เด้งกลับไปหน้า index.html ทันที
            window.location.replace('index.html');
        }
        
        // ลบ "ตั๋ว" ทิ้งทันที
        // เพื่อที่ว่าเมื่อมีการรีเฟรช (F5) ครั้งต่อไป
        // 'allowAppAccess' จะกลายเป็น null และ script ด้านบนจะทำงาน
        sessionStorage.removeItem('allowAppAccess');
    </script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* --- General Styling --- */
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --border-radius: 0.5rem;
        }

        body {
            font-family: var(--font-family);
            margin: 0;
            background-color: var(--light-color);
            color: var(--dark-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
            min-height: 100vh;
        }

        main {
            width: 100%;
            max-width: 800px;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* --- Navigation --- */
        nav {
            display: flex;
            flex-wrap: wrap; /* For responsiveness on small screens */
            background-color: #fff;
            border-bottom: 1px solid #dee2e6;
        }

        nav button {
            flex: 1;
            padding: 1rem;
            font-size: 1rem;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease-in-out;
            color: var(--secondary-color);
            min-width: 120px;
        }

        nav button:hover {
            background-color: var(--light-color);
        }

        nav button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        /* --- Tool Panels --- */
        .tool-panel {
            padding: 2rem;
        }

        .hidden {
            display: none;
        }

        h2 {
            margin-top: 0;
            color: var(--dark-color);
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }

        /* --- File Upload Area --- */
        #upload-area {
            border: 2px dashed #ccc;
            border-radius: var(--border-radius);
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }

        #upload-area.dragover {
            background-color: #e9f5ff;
            border-color: var(--primary-color);
        }

        #upload-area p {
            margin: 0;
            font-size: 1.1rem;
            color: #666;
        }

        #file-input {
            display: none;
        }

        /* --- File List --- */
        #file-list {
            margin-top: 1.5rem;
            list-style: none;
            padding: 0;
        }

        #file-list li {
            background-color: var(--light-color);
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }

        /* --- Action Button & Inputs --- */
        .action-container {
            margin-top: 2rem;
            text-align: center;
        }

        .action-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .action-btn:disabled {
            background-color: #a0c9f7;
            cursor: not-allowed;
        }
        
        .action-btn:not(:disabled):hover {
            background-color: #0056b3;
        }
        
        .input-group {
            margin-top: 1rem;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 0.5rem;
            font-size: 1rem;
            border-radius: var(--border-radius);
            border: 1px solid #ccc;
            box-sizing: border-box;
        }

        /* --- Status Feedback --- */
        #status {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: var(--border-radius);
            text-align: center;
            font-weight: 500;
        }
        
        #status.processing {
            background-color: #e9ecef;
            color: var(--dark-color);
        }

        #status.success {
            background-color: #d4edda;
            color: #155724;
        }

        #status.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .loader {
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body>

    <main>
        <nav>
            <button id="nav-merge" class="nav-btn active" data-tool="merge">รวมไฟล์ PDF</button>
            <button id="nav-split" class="nav-btn" data-tool="split">แยกไฟล์ PDF</button>
            <button id="nav-compress" class="nav-btn" data-tool="compress">บีบอัด PDF</button>
            <button id="nav-rotate" class="nav-btn" data-tool="rotate">หมุนหน้า PDF</button>
            <button id="nav-image-to-pdf" class="nav-btn" data-tool="image-to-pdf">รูปภาพเป็น PDF</button>
        </nav>

        <div id="merge-tool" class="tool-panel">
            <h2>รวมไฟล์ PDF</h2>
            <p>รวม PDF หลายไฟล์ให้เป็นเอกสารเดียว</p>
        </div>

        <div id="split-tool" class="tool-panel hidden">
            <h2>แยกไฟล์ PDF</h2>
            <p>เลือกหน้าที่ต้องการจากไฟล์ PDF ของคุณ</p>
            <div class="input-group">
                <label for="page-ranges">หน้าที่ต้องการ (เช่น 1, 3-5, 8)</label>
                <input type="text" id="page-ranges" placeholder="ตัวอย่าง: 1-3, 5">
            </div>
        </div>

        <div id="compress-tool" class="tool-panel hidden">
            <h2>บีบอัด PDF</h2>
            <p>ลดขนาดไฟล์ PDF ของคุณ (การบีบอัดระดับพื้นฐาน)</p>
        </div>
        
        <div id="rotate-tool" class="tool-panel hidden">
            <h2>หมุนหน้า PDF</h2>
            <p>เลือกองศาและหน้าที่ต้องการหมุน</p>
            <div class="input-group">
                <label for="rotate-pages">หน้าที่ต้องการหมุน (เช่น 1, 3-5, หรือ all สำหรับทุกหน้า)</label>
                <input type="text" id="rotate-pages" placeholder="all">
            </div>
            <div class="input-group">
                <label for="rotate-angle">องศาที่ต้องการหมุน</label>
                <select id="rotate-angle">
                    <option value="90">90° ตามเข็มนาฬิกา</option>
                    <option value="180">180°</option>
                    <option value="270">270° ตามเข็มนาฬิกา (หรือ 90° ทวนเข็ม)</option>
                </select>
            </div>
        </div>

        <div id="image-to-pdf-tool" class="tool-panel hidden">
            <h2>แปลงรูปภาพเป็น PDF</h2>
            <p>อัปโหลดไฟล์ JPG หรือ PNG เพื่อรวมเป็นเอกสาร PDF เดียว</p>
        </div>

        <div id="shared-ui" class="tool-panel">
            <div id="upload-area">
                <p>คลิกเพื่อเลือกไฟล์ หรือลากและวางไฟล์ที่นี่</p>
                <input type="file" id="file-input" multiple accept=".pdf">
            </div>

            <ul id="file-list"></ul>
            
            <div id="status" class="hidden"></div>

            <div class="action-container">
                <button id="action-btn" class="action-btn" disabled>ดำเนินการ</button>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- GLOBAL VARIABLES & CONSTANTS ---
            const { PDFDocument, degrees } = PDFLib;
            let currentTool = 'merge';
            let selectedFiles = [];

            // --- DOM ELEMENTS ---
            const navButtons = document.querySelectorAll('.nav-btn');
            const toolPanels = document.querySelectorAll('.tool-panel');
            const sharedUI = document.getElementById('shared-ui');
            const uploadArea = document.getElementById('upload-area');
            const fileInput = document.getElementById('file-input');
            const fileList = document.getElementById('file-list');
            const actionBtn = document.getElementById('action-btn');
            const statusDiv = document.getElementById('status');
            const pageRangesInput = document.getElementById('page-ranges');
            const rotatePagesInput = document.getElementById('rotate-pages');
            const rotateAngleSelect = document.getElementById('rotate-angle');
            
            // --- INITIALIZATION ---
            document.getElementById('merge-tool').appendChild(sharedUI);
            updateActionButtonText();
            
            // --- HELPER FUNCTIONS ---
            const triggerDownload = (bytes, fileName) => {
                const blob = new Blob([bytes], { type: 'application/pdf' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const showStatus = (type, message) => {
                statusDiv.className = '';
                statusDiv.classList.add(type);
                let content = type === 'processing' ? `<div class="loader"></div> ${message}` : message;
                statusDiv.innerHTML = content;
                statusDiv.classList.remove('hidden');
            };

            const hideStatus = () => statusDiv.classList.add('hidden');
            
            const resetUI = () => {
                selectedFiles = [];
                fileList.innerHTML = '';
                fileInput.value = '';
                actionBtn.disabled = true;
                pageRangesInput.value = '';
                rotatePagesInput.value = '';
                hideStatus();
            };

            const updateActionButtonText = () => {
                switch(currentTool) {
                    case 'merge': actionBtn.textContent = 'รวมไฟล์ PDF'; break;
                    case 'split': actionBtn.textContent = 'แยกไฟล์ PDF'; break;
                    case 'compress': actionBtn.textContent = 'บีบอัดไฟล์'; break;
                    case 'rotate': actionBtn.textContent = 'หมุนหน้า PDF'; break;
                    case 'image-to-pdf': actionBtn.textContent = 'สร้างไฟล์ PDF'; break;
                }
            };

            const renderFileList = () => {
                fileList.innerHTML = '';
                selectedFiles.forEach(file => {
                    const li = document.createElement('li');
                    const fileSize = (file.size / 1024 / 1024).toFixed(2);
                    li.textContent = `${file.name} (${fileSize} MB)`;
                    fileList.appendChild(li);
                });
                actionBtn.disabled = selectedFiles.length === 0;
            };

            const handleFileSelect = (files) => {
                hideStatus();
                const singleFileTools = ['split', 'compress', 'rotate'];
                if (singleFileTools.includes(currentTool) && files.length > 1) {
                    showStatus('error', 'เครื่องมือนี้รองรับเพียง 1 ไฟล์เท่านั้น');
                    return;
                }
                selectedFiles = Array.from(files);
                renderFileList();
            };

            const parsePageRanges = (rangeString, maxPage) => {
                const pages = new Set();
                if (!rangeString) throw new Error("กรุณาระบุช่วงของหน้า");
                const parts = rangeString.split(',');
                for (const part of parts) {
                    const trimmedPart = part.trim();
                    if (trimmedPart.includes('-')) {
                        const [start, end] = trimmedPart.split('-').map(num => parseInt(num.trim(), 10));
                        if (isNaN(start) || isNaN(end) || start > end || start < 1 || end > maxPage) throw new Error(`ช่วงของหน้าไม่ถูกต้อง: "${trimmedPart}"`);
                        for (let i = start; i <= end; i++) pages.add(i - 1);
                    } else {
                        const pageNum = parseInt(trimmedPart, 10);
                        if (isNaN(pageNum) || pageNum < 1 || pageNum > maxPage) throw new Error(`หมายเลขหน้าไม่ถูกต้อง: "${trimmedPart}"`);
                        pages.add(pageNum - 1);
                    }
                }
                return Array.from(pages).sort((a, b) => a - b);
            };

            // --- TOOL-SPECIFIC LOGIC ---

            /** 1. MERGE PDF LOGIC */
            const mergePdfs = async () => {
                if (selectedFiles.length < 2) {
                    showStatus('error', 'กรุณาเลือกไฟล์ PDF อย่างน้อย 2 ไฟล์');
                    return;
                }
                showStatus('processing', 'กำลังรวมไฟล์...');
                try {
                    const mergedPdf = await PDFDocument.create();
                    for (const file of selectedFiles) {
                        const pdf = await PDFDocument.load(await file.arrayBuffer());
                        const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                        copiedPages.forEach(page => mergedPdf.addPage(page));
                    }
                    triggerDownload(await mergedPdf.save(), 'merged.pdf');
                    showStatus('success', 'รวมไฟล์สำเร็จ!');
                } catch (err) {
                    console.error(err);
                    showStatus('error', 'เกิดข้อผิดพลาดในการรวมไฟล์');
                }
            };
            
            /** 2. SPLIT PDF LOGIC */
            const splitPdf = async () => {
                if (selectedFiles.length !== 1) { showStatus('error', 'กรุณาเลือกไฟล์ PDF 1 ไฟล์'); return; }
                if (!pageRangesInput.value) { showStatus('error', 'กรุณากรอกหน้าที่ต้องการ'); return; }
                showStatus('processing', 'กำลังแยกหน้า...');
                try {
                    const existingPdf = await PDFDocument.load(await selectedFiles[0].arrayBuffer());
                    const pageIndices = parsePageRanges(pageRangesInput.value, existingPdf.getPageCount());
                    if (pageIndices.length === 0) { showStatus('error', 'ไม่พบหน้าที่ต้องการ'); return; }
                    
                    const newPdf = await PDFDocument.create();
                    const copiedPages = await newPdf.copyPages(existingPdf, pageIndices);
                    copiedPages.forEach(page => newPdf.addPage(page));
                    
                    triggerDownload(await newPdf.save(), 'split.pdf');
                    showStatus('success', 'แยกหน้าสำเร็จ!');
                } catch (err) {
                    console.error(err);
                    showStatus('error', err.message || 'เกิดข้อผิดพลาดในการแยกหน้า');
                }
            };
            
            /** 3. COMPRESS PDF LOGIC */
            const compressPdf = async () => {
                if (selectedFiles.length !== 1) { showStatus('error', 'กรุณาเลือกไฟล์ PDF 1 ไฟล์'); return; }
                showStatus('processing', 'กำลังบีบอัดไฟล์...');
                try {
                    const file = selectedFiles[0];
                    const pdfDoc = await PDFDocument.load(await file.arrayBuffer());
                    const compressedBytes = await pdfDoc.save({ useObjectStreams: true });
                    const reduction = (((file.size - compressedBytes.length) / file.size) * 100).toFixed(2);
                    triggerDownload(compressedBytes, 'compressed.pdf');
                    showStatus('success', `บีบอัดสำเร็จ! ลดขนาดลง ${reduction}%`);
                } catch (err) {
                    console.error(err);
                    showStatus('error', 'เกิดข้อผิดพลาดในการบีบอัดไฟล์');
                }
            };

            /** 4. ROTATE PDF LOGIC */
            const rotatePdf = async () => {
                if (selectedFiles.length !== 1) { showStatus('error', 'กรุณาเลือกไฟล์ PDF 1 ไฟล์'); return; }
                showStatus('processing', 'กำลังหมุนหน้าเอกสาร...');
                try {
                    const pdfDoc = await PDFDocument.load(await selectedFiles[0].arrayBuffer());
                    const pageCount = pdfDoc.getPageCount();
                    let pageIndices;
                    const pagesToRotate = rotatePagesInput.value.trim().toLowerCase() || 'all';

                    if (pagesToRotate === 'all') {
                        pageIndices = pdfDoc.getPageIndices();
                    } else {
                        pageIndices = parsePageRanges(pagesToRotate, pageCount);
                    }

                    const angle = parseInt(rotateAngleSelect.value, 10);
                    pageIndices.forEach(pageIndex => {
                        const page = pdfDoc.getPage(pageIndex);
                        page.setRotation(degrees(page.getRotation().angle + angle));
                    });

                    triggerDownload(await pdfDoc.save(), 'rotated.pdf');
                    showStatus('success', 'หมุนหน้าเอกสารสำเร็จ!');
                } catch (err) {
                    console.error(err);
                    showStatus('error', err.message || 'เกิดข้อผิดพลาดในการหมุนหน้าเอกสาร');
                }
            };

            /** 5. IMAGE TO PDF LOGIC (Fixed for PNG) */
            const convertImagesToPdf = async () => {
                if (selectedFiles.length === 0) { showStatus('error', 'กรุณาเลือกไฟล์รูปภาพ'); return; }
                showStatus('processing', 'กำลังแปลงรูปภาพเป็น PDF...');
                try {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF();
                    
                    for (let i = 0; i < selectedFiles.length; i++) {
                        const file = selectedFiles[i];
                        const image = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = e => resolve(e.target.result);
                            reader.onerror = reject;
                            reader.readAsDataURL(file);
                        });

                        const fileType = file.type;
                        let format;
                        if (fileType === 'image/jpeg') {
                            format = 'JPEG';
                        } else if (fileType === 'image/png') {
                            format = 'PNG';
                        } else {
                            console.warn(`Skipping unsupported file type: ${file.name}`);
                            showStatus('error', `ไม่รองรับไฟล์ ${file.name}`);
                            return; 
                        }

                        const img = new Image();
                        img.src = image;
                        await new Promise(resolve => { img.onload = resolve; });

                        const pageWidth = pdf.internal.pageSize.getWidth();
                        const pageHeight = pdf.internal.pageSize.getHeight();
                        const ratio = Math.min(pageWidth / img.width, pageHeight / img.height);
                        const imgWidth = img.width * ratio;
                        const imgHeight = img.height * ratio;

                        if (i > 0) pdf.addPage();
                        
                        pdf.addImage(image, format, (pageWidth - imgWidth) / 2, (pageHeight - imgHeight) / 2, imgWidth, imgHeight);
                    }
                    pdf.save('converted-images.pdf');
                    showStatus('success', 'แปลงรูปภาพเป็น PDF สำเร็จ!');
                } catch (err) {
                    console.error(err);
                    showStatus('error', 'เกิดข้อผิดพลาดในการแปลงไฟล์รูปภาพ');
                }
            };


            // --- EVENT LISTENERS ---
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    currentTool = button.dataset.tool;
                    resetUI();
                    updateActionButtonText();
                    
                    toolPanels.forEach(panel => panel.classList.add('hidden'));
                    const activePanel = document.getElementById(`${currentTool}-tool`);
                    activePanel.classList.remove('hidden');
                    activePanel.appendChild(sharedUI);
                    
                    if (currentTool === 'image-to-pdf') {
                        fileInput.accept = ".jpg, .jpeg, .png";
                        fileInput.multiple = true;
                    } else {
                        fileInput.accept = ".pdf";
                        fileInput.multiple = (currentTool === 'merge');
                    }
                });
            });

            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
            uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFileSelect(e.dataTransfer.files);
            });
            fileInput.addEventListener('change', (e) => handleFileSelect(e.target.files));

            actionBtn.addEventListener('click', () => {
                switch (currentTool) {
                    case 'merge': mergePdfs(); break;
                    case 'split': splitPdf(); break;
                    case 'compress': compressPdf(); break;
                    case 'rotate': rotatePdf(); break;
                    case 'image-to-pdf': convertImagesToPdf(); break;
                }
            });
        });
    </script>
</body>
</html>
